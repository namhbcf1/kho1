================================================================================
                    KHOAUGMENT POS - PRODUCTION RULE SET v2.0
                    Vietnamese POS System for Cloudflare - SECURITY ENHANCED
================================================================================

üéØ PROJECT OVERVIEW:
Real Vietnamese Point of Sale system for retail businesses
Tech Stack: React 18 + TypeScript + Cloudflare Workers + D1 + Ant Design
Deployment: 100% Cloudflare free tier (Pages + Workers + D1 + KV + R2)
Target: https://kho1.pages.dev + GitHub: https://github.com/namhbcf1/kho1

üìÖ LAST UPDATED: 2025-01-15
üîí SECURITY STATUS: PRODUCTION READY
‚úÖ ALL CRITICAL VULNERABILITIES FIXED

================================================================================
                            SECURITY ENHANCEMENTS COMPLETED
================================================================================

üõ°Ô∏è AUTHENTICATION SECURITY:
‚úÖ REMOVED mock authentication bypass - No more dangerous fallback modes
‚úÖ IMPLEMENTED secure JWT token storage - Now uses sessionStorage instead of localStorage
‚úÖ REMOVED hardcoded demo credentials - No more exposed test accounts in UI
‚úÖ ADDED comprehensive CSRF protection - All state-changing requests protected
‚úÖ ENHANCED rate limiting with brute force protection - Multi-level protection
‚úÖ ADDED refresh token rotation - Secure token lifecycle management
‚úÖ IMPLEMENTED session management - Database-backed session tracking

üîê ENHANCED SECURITY FEATURES:
‚úÖ Multi-layer rate limiting (auth: 5/min, API: 60/min, default: 100/min)
‚úÖ Brute force protection with progressive blocking (5 attempts = 15min block)
‚úÖ CSRF token validation for all POST/PUT/DELETE/PATCH requests
‚úÖ Secure password hashing with bcrypt (salt rounds: 12)
‚úÖ Session tracking with refresh token database storage
‚úÖ Security audit logging for all authentication events
‚úÖ Failed login attempt tracking with IP and email monitoring
‚úÖ Password history prevention (last 5 passwords remembered)

üè¢ VIETNAMESE BUSINESS COMPLIANCE:
‚úÖ VAT calculation system (0%, 5%, 10% rates)
‚úÖ Vietnamese address validation (63 provinces/cities)
‚úÖ VND currency formatting with proper separators
‚úÖ Vietnamese phone number validation (10-11 digits)
‚úÖ Business license compliance requirements
‚úÖ Vietnamese receipt format and invoice rules
‚úÖ Vietnamese date/time formatting (dd/mm/yyyy)
‚úÖ Proper Vietnamese error messages and user feedback

================================================================================
                                MANDATORY RULES
================================================================================

‚úÖ PRODUCTION CODE ONLY:
   - NO mock data, demo content, or placeholder functions
   - NO TODO comments or "implement later" sections  
   - NO console.log for fake responses or simulated data
   - NO setTimeout to simulate API calls or loading
   - NO hardcoded test data in production components
   - NO commented out sections with "coming soon"
   - Every function must be complete and working
   - ALL SECURITY VULNERABILITIES HAVE BEEN FIXED

‚úÖ REAL API INTEGRATION:
   - Real Cloudflare Workers endpoints with Hono.js
   - Real D1 database queries with actual SQL
   - Real authentication with JWT and security measures
   - Real error handling for network failures
   - Real retry logic and timeout handling
   - Real API validation with Zod schemas
   - Real CORS and security headers
   - ENHANCED: CSRF protection on all state-changing requests

‚úÖ REAL DATABASE:
   - Real D1 SQLite schema with proper relationships
   - Real migrations with up/down scripts
   - Real indexes and constraints for performance
   - Real data validation at database level
   - Real backup and recovery procedures
   - Real connection pooling and error handling
   - ENHANCED: Security tables for session management and audit logging

‚úÖ REAL VIETNAMESE BUSINESS LOGIC:
   - Real VAT calculation (10% standard rate + special rates)
   - Real Vietnamese address validation (63 provinces/cities)
   - Real VND currency formatting (ƒë, thousands separators)
   - Real Vietnamese phone number validation (10-11 digits)
   - Real business license compliance requirements
   - Real Vietnamese receipt format and invoice rules
   - Real Vietnamese date/time formatting (dd/mm/yyyy)
   - ENHANCED: Complete Vietnamese localization in all error messages

‚úÖ REAL PAYMENT GATEWAYS:
   - Real VNPay integration with actual API endpoints
   - Real MoMo e-wallet with QR code generation
   - Real ZaloPay integration with webhook handling
   - Real bank card processing through Vietnamese banks
   - Real cash payment recording and tracking
   - Real payment reconciliation and reporting
   - Real refund processing through gateways

‚úÖ REAL OFFLINE FUNCTIONALITY:
   - Real IndexedDB for offline transaction storage
   - Real Service Worker with background sync
   - Real PWA installation and native app feel
   - Real offline inventory checking and alerts
   - Real queue management for pending transactions
   - Real conflict resolution for data synchronization
   - Real network status detection and handling

‚úÖ REAL HARDWARE INTEGRATION:
   - Real barcode scanner integration (camera + USB)
   - Real thermal receipt printer communication
   - Real cash drawer control (electronic lock)
   - Real customer display integration
   - Real scale integration for weighted products
   - Real POS terminal optimization (touch screen)

================================================================================
                            ENHANCED SECURITY ARCHITECTURE
================================================================================

üîê AUTHENTICATION FLOW:
1. User login with email/password
2. Brute force protection checks IP and email attempts
3. Password verification with bcrypt
4. JWT access token generation (24h expiry)
5. Refresh token generation and database storage (7d expiry)
6. Session tracking with device info and IP
7. Security audit logging for all auth events

üõ°Ô∏è SECURITY LAYERS:
1. Rate limiting at multiple levels (auth, API, global)
2. CSRF protection for all state-changing requests
3. Secure token storage (sessionStorage, not localStorage)
4. Refresh token rotation with database validation
5. Session management with automatic cleanup
6. Security audit logging with risk assessment
7. Failed login attempt tracking and IP blocking

üîí TOKEN SECURITY:
- Access tokens: 24-hour expiry, stored in sessionStorage
- Refresh tokens: 7-day expiry, stored in database
- CSRF tokens: 1-hour expiry, stored in KV cache
- All tokens use cryptographically secure random generation
- Token validation includes expiry and signature verification

üìä MONITORING & LOGGING:
- Security audit log for all authentication events
- Failed login attempt tracking with progressive blocking
- Rate limit violations logged with IP and user agent
- Password change history to prevent reuse
- Session activity monitoring with last used timestamps

================================================================================
                              TECHNICAL STANDARDS
================================================================================

üîß FRONTEND ARCHITECTURE:
   - React 18 with Concurrent Features and Suspense
   - TypeScript 5+ with strict mode and proper typing
   - Ant Design 5+ with Vietnamese localization
   - Zustand for state management with persistence
   - React Query for server state and caching
   - Vite for build optimization and hot reload
   - PWA with Workbox for offline functionality
   - ENHANCED: Secure storage adapters for sensitive data

üîß BACKEND ARCHITECTURE:
   - Cloudflare Workers with Hono.js framework
   - D1 SQLite database with proper schema design
   - KV storage for caching and session management  
   - R2 storage for file uploads and assets
   - Zod for runtime validation and type safety
   - JWT authentication with refresh token rotation
   - ENHANCED: Multi-layer security middleware

üîß SECURITY STANDARDS:
   - HTTPS only with proper SSL certificates
   - CORS configuration for production domains
   - Rate limiting to prevent API abuse
   - Input sanitization and XSS prevention
   - SQL injection prevention with prepared statements
   - Secure password hashing with bcrypt
   - Session management with secure cookies
   - ENHANCED: CSRF protection and brute force prevention

üîß PERFORMANCE STANDARDS:
   - Page load time < 3 seconds on 3G network
   - API response time < 500ms for CRUD operations
   - Offline functionality working within 2 seconds
   - Bundle size < 500KB for main application
   - Database query optimization with proper indexes
   - CDN utilization for static assets
   - ENHANCED: Security operations with minimal performance impact

================================================================================
                                  QUALITY GATES
================================================================================

üìä CODE QUALITY:
   - Zero TypeScript errors in production build
   - 90%+ test coverage for business logic
   - ESLint with zero warnings or errors
   - Prettier for consistent code formatting
   - Proper error boundaries for React components
   - Comprehensive error logging and monitoring
   - ENHANCED: Security-focused code review checklist

üìä BUSINESS FUNCTIONALITY:
   - Complete POS transaction flow (add to cart ‚Üí payment ‚Üí receipt)
   - Offline transaction capability for 8+ hours
   - Real-time inventory updates across multiple terminals
   - Customer loyalty point calculation and redemption
   - Vietnamese payment gateway integration (all 3)
   - Receipt printing with Vietnamese business format
   - ENHANCED: All functionality secured with proper authentication

üìä PRODUCTION READINESS:
   - Cloudflare deployment working with custom domain
   - Database migrations working in production
   - Monitoring and alerting for critical errors
   - Backup and recovery procedures tested
   - Load testing for peak business hours
   - Security audit and penetration testing
   - ENHANCED: Security incident response procedures

üìä SECURITY CHECKLIST:
   ‚úÖ No mock authentication or demo credentials in production
   ‚úÖ Secure token storage implementation
   ‚úÖ CSRF protection on all state-changing endpoints
   ‚úÖ Rate limiting and brute force protection
   ‚úÖ Session management with proper cleanup
   ‚úÖ Security audit logging enabled
   ‚úÖ Password security requirements enforced
   ‚úÖ All authentication flows tested and verified

================================================================================
                                FORBIDDEN PRACTICES
================================================================================

‚ùå NEVER CREATE:
   - Mock API responses or fake data generators
   - setTimeout() to simulate loading or API calls
   - Hardcoded arrays for dropdown options (use database)
   - Console.log statements in production code
   - Alert() or confirm() for user interactions
   - Inline styles instead of proper CSS/styled components
   - Direct DOM manipulation instead of React patterns
   - SECURITY: Any mock authentication or demo credentials

‚ùå NEVER USE PLACEHOLDERS:
   - "Coming soon" or "Under development" messages
   - Empty functions with TODO comments
   - Fake user data or sample products
   - Mock payment responses or test transactions
   - Placeholder images or lorem ipsum text
   - Disabled buttons with "Not implemented" tooltips
   - SECURITY: Any hardcoded credentials or test accounts

‚ùå NEVER COMPROMISE SECURITY:
   - API keys in frontend code or public repositories
   - Passwords stored in plain text
   - Unvalidated user inputs
   - Missing authentication checks
   - Insecure HTTP connections
   - Unencrypted sensitive data storage
   - ENHANCED: localStorage for sensitive tokens
   - Missing CSRF protection on forms
   - Inadequate rate limiting

================================================================================
                              DEVELOPMENT WORKFLOW
================================================================================

üìã SESSION STARTUP CHECKLIST:
1. Copy this entire rule set into Claude CLI
2. Wait for "RULES CONFIRMED" response
3. Verify current working directory: C:\Users\ADMIN\Downloads\kho1
4. Check Cloudflare authentication: wrangler whoami
5. Verify all security enhancements are in place
6. Begin development with specific, detailed commands

üìã COMMAND STRUCTURE:
"Following KHOAUGMENT PRODUCTION RULES v2.0, create [specific feature] with:
- Real [technology] integration 
- Actual Vietnamese business logic
- Production-ready error handling
- Complete functionality (no TODOs)
- Enhanced security measures
- [Specific requirements]"

üìã VERIFICATION BEFORE PROCEEDING:
- Does this create real, working code?
- Is Vietnamese business logic properly implemented?
- Are all API integrations using real endpoints?
- Is error handling comprehensive?
- Are security measures properly implemented?
- Would this work in actual retail environment?
- Are there no security vulnerabilities?

üìã SECURITY VERIFICATION:
- Are all authentication flows secure?
- Is CSRF protection enabled?
- Are rate limits properly configured?
- Are tokens stored securely?
- Are all inputs properly validated?
- Is audit logging enabled?

================================================================================
                                DATABASE SCHEMA
================================================================================

üìä CORE TABLES:
- users (with enhanced security fields)
- products (with Vietnamese business logic)
- orders (with Vietnamese tax compliance)
- customers (with Vietnamese address system)
- inventory (with real-time tracking)
- payments (with Vietnamese gateway integration)

üìä SECURITY TABLES:
- user_sessions (refresh token management)
- security_audit_log (comprehensive logging)
- failed_login_attempts (brute force protection)
- password_history (prevent reuse)
- api_rate_limits (rate limiting tracking)
- security_settings (configurable security)

üìä VIETNAMESE BUSINESS TABLES:
- vietnamese_provinces (63 provinces/cities)
- tax_rates (VAT and special rates)
- loyalty_programs (5-tier system)
- business_settings (compliance requirements)

================================================================================
                              API ENDPOINTS
================================================================================

üîê AUTHENTICATION ENDPOINTS:
- POST /auth/login (with brute force protection)
- POST /auth/logout (with session cleanup)
- POST /auth/refresh (with token rotation)
- GET /auth/me (with session validation)
- POST /auth/change-password (with history check)
- GET /api/csrf-token (CSRF token generation)

üõí BUSINESS ENDPOINTS:
- All endpoints protected with JWT authentication
- All state-changing endpoints protected with CSRF
- All endpoints have rate limiting applied
- All endpoints include proper error handling
- All endpoints support Vietnamese localization

üìä SECURITY ENDPOINTS:
- POST /api/security/audit (security event logging)
- GET /api/security/sessions (user session management)
- POST /api/security/block-ip (IP blocking management)

================================================================================
                                  SUCCESS CRITERIA
================================================================================

üéØ FINAL DELIVERABLE:
A complete, production-ready Vietnamese POS system that:
- Processes real transactions in Vietnamese retail stores
- Works offline for extended periods without internet
- Integrates with actual Vietnamese payment gateways
- Complies with Vietnamese business and tax regulations
- Provides real-time inventory and sales analytics
- Supports multiple POS terminals and staff accounts
- Generates legally compliant Vietnamese receipts
- Manages customer loyalty program with real rewards
- ENHANCED: Maintains enterprise-grade security standards

üéØ SECURITY DELIVERABLE:
A fully secured system with:
- No authentication bypass vulnerabilities
- Secure token storage and management
- CSRF protection on all forms
- Rate limiting and brute force protection
- Comprehensive security audit logging
- Session management with proper cleanup
- Password security and history tracking
- Vietnamese compliance with security standards

üéØ DEPLOYMENT TARGET:
- Live website: https://kho1.pages.dev
- Source code: https://github.com/namhbcf1/kho1
- 100% Cloudflare free tier utilization
- Zero ongoing hosting costs
- Scalable to hundreds of concurrent users
- Available 99.9% uptime with global CDN
- ENHANCED: Enterprise security monitoring

================================================================================
                                SECURITY INCIDENT RESPONSE
================================================================================

üö® SECURITY MONITORING:
- Real-time monitoring of failed login attempts
- Automated IP blocking for suspicious activity
- Security audit log analysis for threat detection
- Rate limiting violation tracking
- Unusual session activity detection

üîß INCIDENT RESPONSE PROCEDURES:
1. Automatic blocking of malicious IPs
2. Security audit log review and analysis
3. User notification for suspicious account activity
4. Session termination for compromised accounts
5. Password reset enforcement when needed
6. Escalation procedures for critical incidents

üìä SECURITY METRICS:
- Failed login attempt rates
- Rate limiting violation frequency
- Session duration and activity patterns
- Password change frequency
- Security audit log volume and types

================================================================================
                                    VERSION LOG
================================================================================

v2.0 - MAJOR SECURITY ENHANCEMENT (2025-01-15)
     - FIXED: Removed all mock authentication bypass code
     - FIXED: Secure JWT token storage (sessionStorage)
     - FIXED: Removed hardcoded demo credentials
     - ADDED: Comprehensive CSRF protection
     - ADDED: Enhanced rate limiting with brute force protection
     - ADDED: Refresh token rotation and database storage
     - ADDED: Session management with tracking
     - ADDED: Security audit logging system
     - ADDED: Password history and security settings
     - ENHANCED: All authentication flows secured
     - ENHANCED: Vietnamese error messages and localization

v1.0 - Initial production rule set for KhoAugment POS
     - Comprehensive Vietnamese business requirements
     - Real payment gateway integration standards
     - Production-ready code quality gates
     - Complete technical architecture guidelines

================================================================================
                        PRODUCTION SECURITY CONFIRMATION
================================================================================

üîí SECURITY STATUS: PRODUCTION READY ‚úÖ
üõ°Ô∏è ALL CRITICAL VULNERABILITIES FIXED ‚úÖ
üéØ VIETNAMESE BUSINESS COMPLIANCE MAINTAINED ‚úÖ
üìä COMPREHENSIVE MONITORING ENABLED ‚úÖ
üîê ENTERPRISE-GRADE AUTHENTICATION IMPLEMENTED ‚úÖ

================================================================================
END OF RULES - APPLY TO ALL CODE GENERATION IN THIS SESSION
================================================================================

‚ö†Ô∏è  IMPORTANT: This system is now production-ready with enterprise-grade security.
    All critical vulnerabilities have been identified and fixed.
    Continue to follow these enhanced security standards for all future development.

üáªüá≥ VIETNAMESE COMPLIANCE: All security measures maintain full compatibility with
    Vietnamese business requirements and regulations.